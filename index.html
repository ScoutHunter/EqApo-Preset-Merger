<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EQAPO Merger</title>
  <style>
    /* ==================== CSS VARIABLES ==================== */
    :root {
      --bg: #071022;
      --card: #0b1220;
      --muted: #9aa4b2;
      --accent: #7c9cff;
      --value: #f0f0f0;
      --text: #e6eef8;
      <!-- --panel-padding: 16px; -->
      --radius: 12px;
    }

    /* ==================== BASE STYLES ==================== */
    html, body {
      min-height: 100%;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ==================== LAYOUT ==================== */
    .wrap {
      max-width: 90vw;
      margin: 0 auto;
      padding: 18px;
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius);
      padding: 15px 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
    }

    .main-panel {
      display: flex;
    }

    /* ==================== HEADER ==================== */
    h1 {
      margin: 10px 0 24px 0;
      font-weight: 600;
      font-size: 20px;
      text-align: center;
    }

    /* ==================== FILE LIST SECTION ==================== */
    .presets-left {
      display: flex;
      flex-direction: column;
      flex: 0 0 350px;
    }

    .files-list {
      flex: 1;
      overflow: auto;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .add-presets-btn {
      text-align: center;
      margin: 10px 0 25px 0;
    }

    .file-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      margin-bottom: 5px;
    }

    .file-left {
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 100%;
    }

    .file-left .name {
      font-size: 13px;
      color: var(--value);
      word-break: break-word;
      max-width: 260px;
    }

    /* ==================== RIGHT PANEL ==================== */
    .curve-right {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      <!-- gap: 8px; -->
      min-width: 360px;
    }

    #plotCanvas {
      width: 100%;
      height: 640px;
      background: #071322;
      display: block;
    }

    .code-out {
      background: #071322;
      padding: 10px 59px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }

    /* ==================== SETTINGS BAR ==================== */
    .settings-bar {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      padding: 0 58px;
    }

    .setting-card {
      background: rgba(255, 255, 255, 0.03);
      padding: 8px;
      border-radius: 10px;
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      box-sizing: border-box;
    }

    .setting-title {
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .setting-contents {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      gap: 10px;
    }

    .smart-top {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      width: 100%;
    }

    .slider-label {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .note {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    /* ==================== FORM CONTROLS ==================== */
    /* Buttons */
    button.primary {
      background: linear-gradient(90deg, var(--accent), #5b8cff);
      border: 0;
      padding: 8px 12px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    .small-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 4px 7px;
      border-radius: 6px;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    /* File input */
    input[type="file"] {
      display: none;
    }

    /* Range sliders */
    .setting-card input[type="range"] {
      -webkit-appearance: none;
      width: 95%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    .setting-card input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background-color: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .setting-card input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background-color: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider-round {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      transition: 0.3s;
    }

    .slider-round:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: var(--accent);
      border-radius: 50%;
      transition: 0.3s;
    }

    .switch input:checked + .slider-round {
      background-color: rgba(124, 156, 255, 0.5);
    }

    .switch input:checked + .slider-round:before {
      transform: translateX(20px);
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1100px) {
      .main-panel {
        flex-direction: column;
      }

      .presets-left {
        flex: 0 0 auto;
      }

      #plotCanvas {
        height: 300px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Equalizer APO Preset Merger</h1>
    </header>

    <div class="panel">
      <div class="main-panel">
        <!-- Left panel: File list -->
        <div class="presets-left">
          <div class="files-list" id="filesList">
            <div class="add-presets-btn">
              <input id="fileInput" type="file" accept=".txt,.cfg,.ini" multiple />
              <button id="chooseBtn" class="primary">Add presets</button>
            </div>
            <div id="presetsContainer"></div>
          </div>
        </div>

        <!-- Right panel: Canvas and controls -->
        <div class="curve-right">
          <canvas id="plotCanvas"></canvas>

          <!-- Settings bar -->
          <div class="settings-bar">
            <!-- Curve range settings -->
            <div class="setting-card">
              <div class="setting-title">Curve range</div>
              <div class="setting-contents">
                <div class="slider-group">
                  <div class="slider-label">Max dB</div>
                  <input id="maxDb" type="range" min="0" max="12" value="0">
                  <span class="note"><span id="maxDbLabel">0</span> dB</span>
                </div>
                <div class="slider-group">
                  <div class="slider-label">Min dB</div>
                  <input id="minDb" type="range" min="-24" max="-1" value="-12">
                  <span class="note"><span id="minDbLabel">-12</span> dB</span>
                </div>
              </div>
            </div>

            <!-- Smart merge settings -->
            <div class="setting-card">
              <div class="setting-title">Smart Merge</div>
              <div class="setting-contents">
                <div class="smart-top">
                  <label class="switch">
                    <input type="checkbox" id="smartMergeToggle">
                    <span class="slider-round"></span>
                  </label>
                </div>
                <div class="slider-group">
                  <div class="slider-label">Radius</div>
                  <input type="range" id="mergeSlider" min="0" max="500" value="0">
                  <span class="note"><span id="mergeLabel">Exact frequency</span></span>
                </div>
              </div>
            </div>

            <!-- Preamp correction settings -->
            <div class="setting-card">
              <div class="setting-title">Normalization</div>
              <div class="setting-contents">
                <div class="smart-top">
                  <label class="switch">
                    <input type="checkbox" id="preampCorrectionToggle">
                    <span class="slider-round"></span>
                  </label>
                </div>
                <div class="note">Max Peak: -0.1 dB</div>
              </div>
            </div>

          </div>

          <!-- Merged text output -->
          <div id="mergedText" class="code-out"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= CONSTANTS ========= */
const FS = 192000;
const FREQ = { MIN: 1, MAX: 96000, MAX_VISIBLE: 20000 };
const LOG_FREQ = {
  MIN: Math.log10(FREQ.MIN),
  MAX: Math.log10(FREQ.MAX),
  MAX_VISIBLE: Math.log10(FREQ.MAX_VISIBLE)
};

const PLOT = {
  PADDING: { LEFT: 60, RIGHT: 12, TOP: 18, BOTTOM: 40 },
  SAMPLES: 4096,
  LINE_WIDTH: { PRESET: 1.2, MERGED: 2.6 },
  OPACITY_PRESET: 0.45
};

const COLORS = [
  '#ff6b6b','#4ecdc4','#ffe66d','#5dade2','#bb8fce',
  '#48c9b0','#f4d03f','#ec7063','#7c9cff','#2ecc71'
];

const REGEX = {
  PREAMP: /Preamp:\s*([-\d.]+)/i,
  FILTER: /Filter\s*\d+:\s*ON\s*(\w+)\s*Fc\s*([\d.]+)\s*Hz\s*Gain\s*([-\d.]+)\s*dB\s*Q\s*([\d.]+)/i
};

const GRID_FREQ = [1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90,100,200,300,400,500,600,700,800,900,
  1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,20000];

/* ========= STATE ========= */
let presets = [];
let presetCurveCache = new Map();
let animationFrameId = null;

/* ========= DOM ELEMENTS ========= */
const elements = {
  fileInput: document.getElementById('fileInput'),
  chooseBtn: document.getElementById('chooseBtn'),
  filesList: document.getElementById('presetsContainer'),
  mergedText: document.getElementById('mergedText'),
  canvas: document.getElementById('plotCanvas'),
  minDb: document.getElementById('minDb'),
  maxDb: document.getElementById('maxDb'),
  smartMerge: document.getElementById('smartMergeToggle'),
  mergeSlider: document.getElementById('mergeSlider'),
  mergeLabel: document.getElementById('mergeLabel'),
  preampCorrection: document.getElementById('preampCorrectionToggle')
};

const ctx = elements.canvas.getContext('2d');

/* ========= EVENT LISTENERS ========= */
elements.chooseBtn.addEventListener('click', () => elements.fileInput.click());
elements.fileInput.addEventListener('change', handleFiles);

[elements.minDb, elements.maxDb].forEach(slider => {
  slider.addEventListener('input', () => {
    document.getElementById(slider.id + 'Label').textContent = slider.value;
    scheduleUpdate();
  });
});

elements.smartMerge.addEventListener('change', () => {
  presetCurveCache.clear();
  scheduleUpdate();
});
elements.preampCorrection.addEventListener('change', scheduleUpdate);
elements.mergeSlider.addEventListener('input', () => {
  const radius = +elements.mergeSlider.value;
  elements.mergeLabel.textContent = radius === 0 ? 'Exact frequency' : `${radius} Hz`;
  if (elements.smartMerge.checked) {
    scheduleUpdate();
  }
});

/* ========= FILE HANDLING ========= */
function scheduleUpdate() {
  if (animationFrameId !== null) {
    cancelAnimationFrame(animationFrameId);
  }
  animationFrameId = requestAnimationFrame(() => {
    updatePlot();
    animationFrameId = null;
  });
}

async function handleFiles() {
  if (!elements.fileInput.files.length) return;
  
  for (const file of elements.fileInput.files) {
    if (presets.some(p => p.name === file.name)) continue;
    
    const text = await file.text();
    let preamp = 0;
    const filters = [];
    
    for (const line of text.split(/\r?\n/)) {
      const trimmed = line.trim();
      if (!trimmed) continue;
      
      const preampMatch = trimmed.match(REGEX.PREAMP);
      if (preampMatch) {
        preamp = parseFloat(preampMatch[1]);
        continue;
      }
      
      const filterMatch = trimmed.match(REGEX.FILTER);
      if (filterMatch) {
        filters.push({
          type: filterMatch[1].toUpperCase(),
          fc: parseFloat(filterMatch[2]),
          gain: parseFloat(filterMatch[3]),
          q: parseFloat(filterMatch[4])
        });
      }
    }
    
    presets.push({
      preamp,
      filters,
      name: file.name,
      enabled: true,
      color: COLORS[presets.length % COLORS.length]
    });
  }
  
  renderFileList();
  updatePlot();
  elements.fileInput.value = null;
}

/* ========= MERGING LOGIC ========= */
function simpleMerge(presetEntries) {
  if (!presetEntries.length) return { preamp: 0, filters: [] };
  
  const n = presetEntries.length;
  
  // Average preamp gain from all enabled presets
  let avgPreamp = presetEntries.reduce((sum, p) => sum + (p.preamp || 0), 0) / n;
  
  // Merge filters (preamp does not affect filter merging)
  const allFilters = presetEntries.flatMap(p =>
    p.filters.map(f => ({ ...f, gain: f.gain / n }))
  );
  
  const merged = elements.smartMerge.checked 
    ? +elements.mergeSlider.value === 0 
      ? mergeByExactFrequency(allFilters)
      : mergeByRadius(allFilters, +elements.mergeSlider.value)
    : allFilters;
  
  // Apply preamp correction if enabled
  if (elements.preampCorrection.checked) {
    // Calculate max gain across frequency spectrum with filters only (no preamp)
    const maxGain = Math.max(...generateSampleFreqs().map(f => 
      presetGainAtFreqDb(f, { filters: merged, preamp: 0 })
    ));
    
    // Set preamp to bring max gain down to -0.1 dB
    avgPreamp = -maxGain - 0.1;
  }
  
  // Round preamp to 2 decimals and remove trailing zeros
  avgPreamp = +avgPreamp.toFixed(2);
  
  return {
    preamp: avgPreamp,
    filters: merged.map(f => ({
      type: f.type,
      fc: Math.round(f.fc),
      gain: +f.gain.toFixed(2),
      q: +f.q.toFixed(2)
    }))
  };
}

function mergeByExactFrequency(filters) {
  const groups = {};
  
  for (const f of filters) {
	const key = `${f.type}|${Math.round(f.fc * 100) / 100}`;
    (groups[key] ??= []).push(f);
  }
  
  return Object.values(groups).map(group => ({
    type: group[0].type,
    fc: group[0].fc,
    gain: group.reduce((sum, f) => sum + f.gain, 0),
    q: group.reduce((sum, f) => sum + f.q, 0) / group.length
  })).sort((a, b) => a.fc - b.fc);
}

function mergeByRadius(filters, radius) {
  const filtersByType = {};
  
  for (const f of filters) {
    (filtersByType[f.type] ??= []).push({ ...f });
  }
  
  const merged = [];
  
  for (const type in filtersByType) {
    const sorted = filtersByType[type].sort((a, b) => a.fc - b.fc);
    let cluster = [];
    
    for (const f of sorted) {
      if (cluster.length === 0 || f.fc - cluster[cluster.length - 1].fc <= radius) {
        cluster.push(f);
      } else {
        merged.push({
          type,
          fc: cluster.reduce((sum, f) => sum + f.fc, 0) / cluster.length,
          gain: cluster.reduce((sum, f) => sum + f.gain, 0),
          q: cluster.reduce((sum, f) => sum + f.q, 0) / cluster.length
        });
        cluster = [f];
      }
    }
    
    if (cluster.length) {
      merged.push({
        type,
        fc: cluster.reduce((sum, f) => sum + f.fc, 0) / cluster.length,
        gain: cluster.reduce((sum, f) => sum + f.gain, 0),
        q: cluster.reduce((sum, f) => sum + f.q, 0) / cluster.length
      });
    }
  }
  
  return merged.sort((a, b) => a.fc - b.fc);
}

/* ========= FREQUENCY RESPONSE CALCULATION ========= */

function presetGainAtFreqDb(freq, preset) {
  const w = 2 * Math.PI * freq / FS;
  const cosw = Math.cos(w);
  const sinw = Math.sin(w);
  const cos2w = Math.cos(2 * w);
  const sin2w = Math.sin(2 * w);
  
  let totalLinear = 1.0;
  
  for (const f of preset.filters) {
    const A = Math.pow(10, f.gain / 40);
    const w0 = 2 * Math.PI * f.fc / FS;
    const cosw0 = Math.cos(w0);
    const sinw0 = Math.sin(w0);
    const alpha = sinw0 / (2 * Math.max(0.0001, f.q));
    
    let b0, b1, b2, a0, a1, a2;
    
    if (f.type === 'PK' || f.type === 'PEAK') {
      b0 = 1 + alpha * A;
      b1 = -2 * cosw0;
      b2 = 1 - alpha * A;
      a0 = 1 + alpha / A;
      a1 = -2 * cosw0;
      a2 = 1 - alpha / A;
    } 
    else if (['LSC', 'LSHELF', 'LOWSHELF'].includes(f.type)) {
      const term = 2 * Math.sqrt(A) * alpha;
      b0 = A * ((A + 1) - (A - 1) * cosw0 + term);
      b1 = 2 * A * ((A - 1) - (A + 1) * cosw0);
      b2 = A * ((A + 1) - (A - 1) * cosw0 - term);
      a0 = (A + 1) + (A - 1) * cosw0 + term;
      a1 = -2 * ((A - 1) + (A + 1) * cosw0);
      a2 = (A + 1) + (A - 1) * cosw0 - term;
    }
    else if (['HSC', 'HSHELF', 'HIGHSHELF'].includes(f.type)) {
      const term = 2 * Math.sqrt(A) * alpha;
      b0 = A * ((A + 1) + (A - 1) * cosw0 + term);
      b1 = -2 * A * ((A - 1) + (A + 1) * cosw0);
      b2 = A * ((A + 1) + (A - 1) * cosw0 - term);
      a0 = (A + 1) - (A - 1) * cosw0 + term;
      a1 = 2 * ((A - 1) - (A + 1) * cosw0);
      a2 = (A + 1) - (A - 1) * cosw0 - term;
    }
    else {
      // Fallback to gaussian approximation
      totalLinear *= Math.pow(10, gaussianApproxMagnitudeDb(freq, f) / 20);
      continue;
    }
    
    // Normalize coefficients
    b0 /= a0; b1 /= a0; b2 /= a0;
    a1 /= a0; a2 /= a0;
    
    // Calculate magnitude at frequency
    const nr = b0 + b1 * cosw + b2 * cos2w;
    const ni = -b1 * sinw - b2 * sin2w;
    const dr = 1 + a1 * cosw + a2 * cos2w;
    const di = -a1 * sinw - a2 * sin2w;
    
    totalLinear *= Math.max(1e-12, Math.hypot(nr, ni) / Math.hypot(dr, di));
  }
  
  return 20 * Math.log10(Math.max(1e-12, totalLinear)) + (preset.preamp || 0);
}

function gaussianApproxMagnitudeDb(freq, f) {
  const fc = f.fc || 1000;
  const q = f.q > 0 ? f.q : 1.0;
  const bw = Math.max(1, fc / (q * 2));
  const diff = Math.log(freq) - Math.log(fc);
  const std = Math.log(1 + bw / fc);
  
  return std > 0 ? f.gain * Math.exp(-0.5 * (diff / std) ** 2) : 0;
}

function generateSampleFreqs(count = PLOT.SAMPLES) {
  return Array.from({ length: count }, (_, i) => 
    Math.pow(10, LOG_FREQ.MIN + (i / (count - 1)) * (LOG_FREQ.MAX - LOG_FREQ.MIN))
  );
}

/* ========= EXPORT ========= */
function handleExport() {
  const merged = simpleMerge(presets.filter(p => p.enabled));
  const blob = new Blob([formatPresetText(merged)], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Merged_Preset.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function formatPresetText(merged) {
  const sorted = merged.filters.slice().sort((a, b) => a.fc - b.fc);
  return `Preamp: ${merged.preamp} dB\n` + 
    sorted.map((f, i) => `Filter ${i + 1}: ON ${f.type} Fc ${f.fc} Hz Gain ${f.gain} dB Q ${f.q}`).join('\n');
}

/* ========= UI RENDERING ========= */
function renderFileList() {
  elements.filesList.innerHTML = '';
  
  presets.forEach((preset, index) => {
    const row = document.createElement('div');
    row.className = 'file-row';
    row.innerHTML = `
      <div class="file-left">
        <input type="checkbox" ${preset.enabled ? 'checked' : ''}>
        <span class="name" style="color:${preset.color}">${preset.name}</span>
      </div>
      <button class="small-btn">Remove</button>
    `;
    
	row.querySelector('input').addEventListener('change', e => {
      preset.enabled = e.target.checked;
      scheduleUpdate();
    });
    
    row.querySelector('button').addEventListener('click', () => {
      presets.splice(index, 1);
      presetCurveCache.clear();
      renderFileList();
      updatePlot();
    });
    
    elements.filesList.appendChild(row);
  });
}

function updatePlot() {
  const dpr = window.devicePixelRatio || 1;
  const w = elements.canvas.clientWidth;
  const h = elements.canvas.clientHeight;
  
  elements.canvas.width = Math.floor(w * dpr);
  elements.canvas.height = Math.floor(h * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  
  ctx.fillStyle = '#071322';
  ctx.fillRect(0, 0, w, h);
  
  const left = PLOT.PADDING.LEFT;
  const right = w - PLOT.PADDING.RIGHT;
  const top = PLOT.PADDING.TOP;
  const bottom = h - PLOT.PADDING.BOTTOM;
  const minY = +elements.minDb.value;
  const maxY = +elements.maxDb.value;
  
  drawGrid(left, right, top, bottom, minY, maxY);
  
  const enabled = presets.filter(p => p.enabled);
  if (!enabled.length) {
    elements.mergedText.textContent = '';
    return;
  }
  
  const merged = simpleMerge(enabled);
  const sampleFreqs = generateSampleFreqs();
  
  drawPresetCurves(enabled, sampleFreqs, left, right, top, bottom, minY, maxY);
  drawMergedCurve(merged, sampleFreqs, left, right, top, bottom, minY, maxY);
  
  updateMergedText(merged);
}

function drawGrid(left, right, top, bottom, minY, maxY) {
  // X-axis (frequency)
  ctx.fillStyle = '#9aa4b2';
  ctx.font = '12px Inter, Arial';
  ctx.textAlign = 'center';
  
  for (const f of GRID_FREQ) {
    const x = left + ((Math.log10(Math.min(f, FREQ.MAX)) - LOG_FREQ.MIN) / 
              (LOG_FREQ.MAX_VISIBLE - LOG_FREQ.MIN)) * (right - left);
    
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1.4;
    ctx.beginPath();
    ctx.moveTo(x, top);
    ctx.lineTo(x, bottom);
    ctx.stroke();
    ctx.fillText(f >= 1000 ? `${f / 1000}k` : f, x, bottom + 18);
  }
  
  // Y-axis (dB)
  ctx.textAlign = 'right';
  for (let y = Math.ceil(minY); y <= Math.floor(maxY); y++) {
    const yy = bottom - ((y - minY) / (maxY - minY)) * (bottom - top);
    
    ctx.strokeStyle = y === 0 
      ? 'rgba(255,183,77,0.9)' 
      : y % 3 === 0 ? 'rgba(255,255,255,0.12)' : 'rgba(255,255,255,0.06)';
    ctx.lineWidth = y === 0 ? 2 : y % 3 === 0 ? 1.2 : 1;
    
    ctx.beginPath();
    ctx.moveTo(left, yy);
    ctx.lineTo(right, yy);
    ctx.stroke();
    
    if (y % 3 === 0 || y === 0) {
      ctx.fillStyle = y === 0 ? '#ffb74d' : '#9aa4b2';
      ctx.fillText(`${y} dB`, left - 10, yy + 4);
    }
  }
}

function drawPresetCurves(enabled, sampleFreqs, left, right, top, bottom, minY, maxY) {
  ctx.lineWidth = PLOT.LINE_WIDTH.PRESET;
  
  for (const preset of enabled) {
    // Inline caching
    const cacheKey = JSON.stringify({
      preamp: preset.preamp,
      filters: preset.filters
    });
    
    let curve;
    if (presetCurveCache.has(cacheKey)) {
      curve = presetCurveCache.get(cacheKey);
    } else {
      curve = sampleFreqs.map(freq => presetGainAtFreqDb(freq, preset));
      presetCurveCache.set(cacheKey, curve);
    }
    
    const hex = preset.color.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    ctx.strokeStyle = `rgba(${r},${g},${b},${PLOT.OPACITY_PRESET})`;
    
    ctx.beginPath();
    curve.forEach((gain, i) => {
      const freq = sampleFreqs[i];
      const x = left + ((Math.log10(Math.min(freq, FREQ.MAX)) - LOG_FREQ.MIN) / 
                (LOG_FREQ.MAX_VISIBLE - LOG_FREQ.MIN)) * (right - left);
      const y = bottom - ((gain - minY) / (maxY - minY)) * (bottom - top);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
  }
}

function drawMergedCurve(merged, sampleFreqs, left, right, top, bottom, minY, maxY) {
  ctx.lineWidth = PLOT.LINE_WIDTH.MERGED;
  ctx.strokeStyle = '#7c9cff';
  ctx.beginPath();
  
  sampleFreqs.forEach((freq, i) => {
    const gain = presetGainAtFreqDb(freq, merged);
    const x = left + ((Math.log10(Math.min(freq, FREQ.MAX)) - LOG_FREQ.MIN) / 
              (LOG_FREQ.MAX_VISIBLE - LOG_FREQ.MIN)) * (right - left);
    const y = bottom - ((gain - minY) / (maxY - minY)) * (bottom - top);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

function updateMergedText(merged) {
  const container = document.createElement('div');
  container.style.cssText = 'font-size:1.05em; font-family:monospace';
  
  // Preamp line with buttons
  const preampLine = document.createElement('div');
  preampLine.style.cssText = 'display:flex; align-items:center; gap:20px; margin-bottom:1em';
  preampLine.innerHTML = `
    <span><span style="color:#ffb74d">Preamp:</span> <span style="color:#f0f0f0">${merged.preamp} dB</span></span>
    <div style="display:flex; gap:8px">
      <button class="primary" style="font-size:0.9em; padding:5px 10px" data-action="copy">Copy to Clipboard</button>
      <button class="primary" style="font-size:0.9em; padding:5px 10px" data-action="download">Download Preset</button>
    </div>
  `;
  
  let copyTimeout = null;
  
  // Event delegation for buttons
	preampLine.addEventListener('click', (e) => {
	  const btn = e.target.closest('button');
	  if (!btn) return;
	  
	  if (btn.dataset.action === 'copy') {
		if (copyTimeout) {
		  clearTimeout(copyTimeout);
		}
		
		navigator.clipboard.writeText(formatPresetText(merged)).then(() => {
		  const original = btn.textContent;
		  btn.textContent = '         Copied!         ';
		  copyTimeout = setTimeout(() => {
			btn.textContent = original;
			copyTimeout = null;
		  }, 750);
		});
	  } else if (btn.dataset.action === 'download') {
		handleExport();
	  }
	});
  
  container.appendChild(preampLine);
  
  // Filters grid
  const grid = document.createElement('div');
  grid.style.cssText = `
    display:grid;
    grid-template-columns:max-content max-content max-content max-content max-content max-content max-content max-content;
    row-gap:0.2em;
    white-space:nowrap;
    color:#f0f0f0
  `;
  
  merged.filters.slice().sort((a, b) => a.fc - b.fc).forEach((f, i) => {
    const cells = [
      [`<span style="color:#ffb74d">Filter ${i + 1}:</span>`, 'left', '0.6em'],
      [f.type, 'center', '1.2em'],
      ['<span style="color:#7c9cff">Fc</span>', 'center', '0.6em'],
      [`${f.fc} Hz`, 'right', '1.2em'],
      ['<span style="color:#7c9cff">Gain</span>', 'center', '0.6em'],
      [`${f.gain >= 0 ? ' ' : ''}${f.gain} dB`, 'right', '1.2em'],
      ['<span style="color:#7c9cff">Q</span>', 'center', '0.6em'],
      [f.q, 'right', '0']
    ];
    
    cells.forEach(([content, align, padRight]) => {
      const cell = document.createElement('div');
      cell.style.cssText = `text-align:${align}; padding-right:${padRight}`;
      cell.innerHTML = content;
      grid.appendChild(cell);
    });
  });
  
  container.appendChild(grid);
  elements.mergedText.innerHTML = '';
  elements.mergedText.appendChild(container);
}

/* ========= INITIALIZATION ========= */
updatePlot();
</script>
</body>
</html>
